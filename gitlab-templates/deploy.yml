deploy-dev:
  stage: deploy
  script:
    - |
      curl -X PUT $DEV_VERSION_MANAGER_URL/update-image \
      -u $DEV_VERSION_MANAGER_AUTH \
      -H "Secret: $DEV_VERSION_MANAGER_API_SECRET" \
      -H "Content-Type: application/json" \
      --data '{ "service": "'$CI_PROJECT_NAME'", "image": "'$CI_REGISTRY_IMAGE':'$RELEASE_TAG'" }'
    - |
      curl --request POST \
      --form token=$DEPLOY_TRIGGER_TOKEN \
      --form ref=dev \
      --form "variables[TRIGGER_SPECIFIC_JOB]=$CI_PROJECT_NAME" \
      --form "variables[TRIGGER_ENVIRONMENT]=dev" \
      https://gitlab.com/api/v4/projects/$DEPLOY_PROJECT_ID/trigger/pipeline
  when: manual

deploy-prod:
  stage: deploy
  script:
    - |
      curl -X PUT $PROD_VERSION_MANAGER_URL/update-image \
      -u $PROD_VERSION_MANAGER_AUTH \
      -H "Secret: $PROD_VERSION_MANAGER_API_SECRET" \
      -H "Content-Type: application/json" \
      --data '{ "service": "'$CI_PROJECT_NAME'", "image": "'$CI_REGISTRY_IMAGE':'$RELEASE_TAG'" }'
    - |
      curl --request POST \
      --form token=$DEPLOY_TRIGGER_TOKEN \
      --form ref=prod \
      --form "variables[TRIGGER_SPECIFIC_JOB]=$CI_PROJECT_NAME" \
      --form "variables[TRIGGER_ENVIRONMENT]=prod" \
      https://gitlab.com/api/v4/projects/$DEPLOY_PROJECT_ID/trigger/pipeline
  when: manual
